---
const items = [
  {
    name: "MARTIN GARRIX",
    preview: "/martin-garrix.mp4",
    type: "video"
  },
  {
    name: "ANJUNADEEP",
    preview: "/anjunadeep.jpg",
    type: "image"
  },
  {
    name: "COLDPLAY",
    preview: "/coldplay.jpg",
    type: "image"
  },
  {
    name: "BRYAN ADAMS",
    preview: "bryan-adams.png",
    type: "image"
  },
  {
    name: "KLANGKUENSTLER",
    preview: "/klang-preview-3.jpg",
    type: "image"
  },
  {
    name: "KOROLOVA",
    preview: "korolova.mp4",
    type: "video"
  },
  {
    name: "FISHER",
    preview: "/fisher-preview-1.jpg",
    type: "image"
  },
  {
    name: "MARTIN GARRIX",
    preview: "/martin-garrix.mp4",
    type: "video"
  },
  {
    name: "ANJUNADEEP",
    preview: "/anjunadeep.jpg",
    type: "image"
  },
  {
    name: "COLDPLAY",
    preview: "/coldplay.jpg",
    type: "image"
  },
  {
    name: "BRYAN ADAMS",
    preview: "bryan-adams.png",
    type: "image"
  },
  {
    name: "KLANGKUENSTLER",
    preview: "/klang-preview-3.jpg",
    type: "image"
  },
  {
    name: "KOROLOVA",
    preview: "korolova.mp4",
    type: "video"
  },
  {
    name: "FISHER",
    preview: "/fisher-preview-1.jpg",
    type: "image"
  },
];
---

<div
  class="relative flex justify-center items-center bg-[#1c1c1c] w-full min-h-[100vh] h-[100vh] pb-3 overflow-hidden"
>
  <!-- Background Preview Container -->
  <div id="preview-bg" class="absolute inset-0 will-change-contents">
    <!-- Preloaded videos (hidden) -->
    {items.filter(item => item.type === "video").map((item) => (
      <video
        data-video-src={item.preview}
        class="hidden w-full h-full object-cover"
        muted
        loop
        preload="metadata"
      >
        <source src={item.preview} type="video/mp4" />
      </video>
    ))}
    <!-- Initial background image -->
    <div
      id="bg-image"
      class="absolute inset-0 transition-opacity duration-500 ease-in-out bg-cover bg-center"
      style={`background-image: url(${items[0].preview})`}
    ></div>
    <!-- Video container -->
    <div id="bg-video-container" class="absolute inset-0 opacity-0 transition-opacity duration-500 ease-in-out"></div>
  </div>

  <!-- Overlay to darken -->
  <div class="absolute inset-0 bg-black/60"></div>

  <!-- Main List -->
  <div class="flex flex-col justify-center items-center w-full h-full px-4 sm:px-6 md:px-8">
    <!-- List Content -->
    <div
      class="z-10 flex-1 w-full flex flex-col justify-center items-center pt-10"
    >
      <div class="z-20 w-full sm:w-4/5 md:w-3/5 lg:w-1/2 xl:w-[35%] flex h-[30%] justify-start items-end">
          <h1 class="text-3xl font-bold text-gray-100">Highlights.</h1>
      </div>
      <div
        class="h-fit w-full sm:w-4/5 md:w-3/5 lg:w-1/2 xl:w-[35%] flex flex-col justify-start items-center"
        set:html={`
                     ${items
                       .map(
                         (item, idx) =>
                           `<div class="h-[1.75rem] w-full border-t border-gray-400 flex flex-row justify-between items-center group relative overflow-hidden hover-bg-transition will-change-transform" data-preview="${item.preview}" data-type="${item.type}" style="display: flex; align-items: center;">
                        <h2 class="pt-2 text-gray-400 group-hover:text-black cursor-pointer w-full text-lg font-bold hover:font-black text-gray-100 origin-left transition-all duration-300 scale-x-125 hover:scale-x-150 will-change-transform" style="display: flex; justify-content: start; height: 100%;">
                          ${item.name}
                        </h2>
                        <div class="relative w-[20px] h-[20px]" style="display: flex; align-items: center; justify-content: center;">
                            <img src="/assets/up-right-arrow-gray.png" alt="${item.name}" width="20" height="20" class="w-[20px] h-[20px] object-cover transition-opacity duration-300 group-hover:opacity-0" style="filter: contrast(1.8) brightness(0.6) saturate(1.5);" loading="lazy" />
                            <img src="/assets/up-right-arrow-black.png" alt="${item.name}" width="20" height="20" class="w-[20px] h-[20px] object-cover absolute top-0 left-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300" style="filter: contrast(2.0) brightness(0.5) saturate(1.8);" loading="lazy" />
                        </div>
                    </div>`,
                       )
                       .join("")}
                        `}
      />
    </div>
  </div>
</div>

<script>
  // Performance optimized preview switcher
  const bgImage = document.getElementById("bg-image") as HTMLElement | null;
  const bgVideoContainer = document.getElementById("bg-video-container") as HTMLElement | null;
  const preloadedVideos = new Map<string, HTMLVideoElement>();
  
  // Preload and cache video elements
  document.querySelectorAll("[data-video-src]").forEach((video) => {
    const src = video.getAttribute("data-video-src");
    if (src && video instanceof HTMLVideoElement) {
      preloadedVideos.set(src, video);
    }
  });

  let currentVideo: HTMLVideoElement | null = null;
  let isTransitioning = false;

  // Debounce function for performance
  function debounce(func: (...args: any[]) => void, wait: number) {
    let timeout: ReturnType<typeof setTimeout> | undefined;
    return function executedFunction(...args: any[]) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  function switchPreview(previewUrl: string, mediaType: string) {
    if (isTransitioning || !bgImage || !bgVideoContainer) return;
    isTransitioning = true;

    if (mediaType === "video") {
      // Get or create video element
      let video = preloadedVideos.get(previewUrl);
      
      if (!video) {
        video = document.createElement("video");
        video.className = "w-full h-full object-cover";
        video.muted = true;
        video.loop = true;
        video.playsInline = true;
        const source = document.createElement("source");
        source.src = previewUrl;
        source.type = "video/mp4";
        video.appendChild(source);
        preloadedVideos.set(previewUrl, video);
      }

      // Stop current video if any
      if (currentVideo && currentVideo !== video) {
        currentVideo.pause();
        currentVideo.currentTime = 0;
      }

      // Clear container and add new video
      bgVideoContainer.innerHTML = "";
      bgVideoContainer.appendChild(video.cloneNode(true) as HTMLVideoElement);
      const newVideo = bgVideoContainer.querySelector("video") as HTMLVideoElement | null;
      
      if (newVideo) {
        // Start playing
        newVideo.play().catch(() => {});
        currentVideo = newVideo;
      }

      // Fade out image, fade in video
      bgImage.style.opacity = "0";
      bgVideoContainer.style.opacity = "1";
    } else {
      // Stop any playing video
      if (currentVideo) {
        currentVideo.pause();
        currentVideo.currentTime = 0;
      }

      // Update background image
      bgImage.style.backgroundImage = `url(${previewUrl})`;
      bgVideoContainer.style.opacity = "0";
      bgImage.style.opacity = "1";
    }

    setTimeout(() => {
      isTransitioning = false;
    }, 100);
  }

  // Optimized event delegation
  const debouncedSwitch = debounce(switchPreview, 50);

  document.querySelectorAll("[data-preview]").forEach((el) => {
    el.addEventListener("mouseenter", () => {
      const previewUrl = el.getAttribute("data-preview");
      const mediaType = el.getAttribute("data-type");
      if (previewUrl && mediaType) {
        switchPreview(previewUrl, mediaType);
      }
    }, { passive: true });
  });

  // Cleanup on page unload
  window.addEventListener("beforeunload", () => {
    if (currentVideo) {
      currentVideo.pause();
      currentVideo.src = "";
    }
  });
</script>
